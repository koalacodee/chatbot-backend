generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String        @id @default(uuid()) @map("id") @db.Uuid
  name       String        @map("name") @db.VarChar(255)
  email      String        @unique @map("email") @db.VarChar(255)
  username   String        @unique @map("username") @db.VarChar(255)
  password   String        @map("password") @db.Char(97)
  role       UserRole      @map("role")
  employeeId String?       @unique @map("employee_id") @db.VarChar(255)
  jobTitle   String?       @map("job_title") @db.VarChar(255)
  activities ActivityLog[]
  supervisor Supervisor?
  employee   Employee?
  admin      Admin?
  driver     Driver?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Supervisor {
  id                           String                @id @default(uuid()) @map("id") @db.Uuid
  departments                  Department[]
  permissions                  AdminPermissions[]
  userId                       String                @unique @map("user_id") @db.Uuid
  user                         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignerTasks                Task[]                @relation("AssignerOfTask")
  employees                    Employee[]
  promotions                   Promotion[]
  approvedTasks                Task[]                @relation("ApproverOfTask")
  employeeRequests             EmployeeRequest[]     @relation("SupervisorRequests")
  questions                    Question[]
  supportTicketAnswersAuthored SupportTicketAnswer[] @relation("AnswererOfSupportTicketAnswer")
  performerTasks               Task[]                @relation("PerformerOfTask")
  drivers                      Driver[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("supervisors")
}

model Employee {
  id                           String                  @id @default(uuid()) @map("id") @db.Uuid
  userId                       String                  @unique @map("user_id") @db.Uuid
  user                         User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissions                  EmployeePermissions[]
  supervisorId                 String                  @map("supervisor_id") @db.Uuid
  supervisor                   Supervisor              @relation(fields: [supervisorId], references: [id], onDelete: Cascade)
  supportTicketAnswersAssigned SupportTicket[]         @relation("AssigneeOfSupportTicket")
  assigneeTasks                Task[]                  @relation("AssigneeOfTask")
  questions                    Question[]
  supportTicketAnswersAuthored SupportTicketAnswer[]   @relation("AnswererOfSupportTicketAnswer")
  performerTasks               Task[]                  @relation("PerformerOfTask")
  subDepartments               EmployeeSubDepartment[]

  @@map("employees")
}

model Admin {
  id                           String                @id @default(uuid()) @map("id") @db.Uuid
  userId                       String                @unique @map("user_id") @db.Uuid
  user                         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  promotions                   Promotion[]
  approvedTasks                Task[]                @relation("ApproverOfTask")
  adminResolutions             EmployeeRequest[]     @relation("AdminResolutions")
  questions                    Question[]
  supportTicketAnswersAuthored SupportTicketAnswer[] @relation("AnswererOfSupportTicketAnswer")
  performerTasks               Task[]                @relation("PerformerOfTask")
  assignedTasks                Task[]                @relation("AssignerOfTask")

  @@map("admins")
}

model Driver {
  id                   String      @id @default(uuid()) @map("id") @db.Uuid
  userId               String      @unique @map("user_id") @db.Uuid
  user                 User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  supervisorId         String      @map("supervisor_id") @db.Uuid
  supervisor           Supervisor  @relation(fields: [supervisorId], references: [id], onDelete: Cascade)
  licensingNumber      String      @unique @map("licensing_number") @db.VarChar(255)
  drivingLicenseExpiry DateTime    @map("driving_license_expiry") @db.Date
  vehicles             Vehicle[]
  violations           Violation[]
  createdAt            DateTime    @default(now()) @map("created_at")
  updatedAt            DateTime    @updatedAt @map("updated_at")

  @@index([supervisorId])
  @@map("drivers")
}

model EmployeeSubDepartment {
  id           String     @id @default(uuid()) @map("id") @db.Uuid
  employeeId   String     @map("employee_id") @db.Uuid
  employee     Employee   @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  departmentId String     @map("department_id") @db.Uuid
  department   Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  assignedAt   DateTime   @default(now()) @map("assigned_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@unique([employeeId, departmentId])
  @@index([employeeId])
  @@index([departmentId])
  @@map("employee_sub_departments")
}

enum AdminPermissions {
  VIEW_ALL_DASHBOARD     @map("view_all_dashboard")
  MANAGE_SUB_DEPARTMENTS @map("manage_sub_departments")
  MANAGE_DEPARTMENTS     @map("manage_departments")
  MANAGE_PROMOTIONS      @map("manage_promotions")
  APPROVE_STAFF_REQUESTS @map("approve_staff_requests")
  MANAGE_SITE_CONFIG     @map("manage_site_config")
  MANAGE_SUPERVISORS     @map("manage_supervisors")
  VIEW_USER_ACTIVITY     @map("view_user_activity")
  MANAGE_STAFF_DIRECTLY  @map("manage_staff_directly")
  MANAGE_TASKS           @map("manage_tasks")
  MANAGE_DRIVERS         @map("manage_drivers")
}

enum EmployeePermissions {
  HANDLE_TICKETS          @map("handle_tickets")
  HANDLE_TASKS            @map("handle_tasks")
  ADD_FAQS                @map("add_faqs")
  VIEW_ANALYTICS          @map("view_analytics")
  CLOSE_TICKETS           @map("close_tickets")
  MANAGE_KNOWLEDGE_CHUNKS @map("manage_knowledge_chunks")

  @@map("permissions")
}

model Guest {
  id                        String                     @id @default(uuid()) @map("id") @db.Uuid
  name                      String                     @map("name") @db.VarChar(255)
  email                     String                     @unique @map("email") @db.VarChar(255)
  phone                     String?                    @unique @map("phone") @db.VarChar(255)
  conversations             Conversation[]
  interactions              QuestionInteraction[]
  supportTickets            SupportTicket[]
  tickets                   Ticket[]
  supportTicketInteractions SupportTicketInteraction[]
  createdAt                 DateTime                   @default(now()) @map("created_at")
  updatedAt                 DateTime                   @updatedAt @map("updated_at")
  questionViews             QuestionView[]

  @@map("guests")
}

model RefreshToken {
  id        String    @id @default(uuid()) @map("id") @db.Uuid
  token     String    @unique @map("token")
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  revokedAt DateTime? @map("revoked_at")
  targetId  String    @map("target_id") @db.Uuid

  @@map("refresh_tokens")
}

model Department {
  id              String               @id @default(uuid()) @map("id") @db.Uuid
  name            String               @map("name") @db.VarChar(255)
  visibility      DepartmentVisibility @default(PUBLIC) @map("visibility")
  questions       Question[]
  knowledgeChunks KnowledgeChunk[]
  supervisors     Supervisor[]
  tickets         Ticket[]

  // Self-relation fields
  parentId               String?                 @map("parent_id") @db.Uuid
  parent                 Department?             @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  subDepartments         Department[]            @relation("DepartmentHierarchy")
  supportTickets         SupportTicket[]
  employeeSubDepartments EmployeeSubDepartment[]

  // Task assignment relations
  targetTasks         Task[] @relation("TargetDepartment")
  targetSubDepartment Task[] @relation("TargetSubDepartment")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([parentId])
  @@map("departments")
}

enum DepartmentVisibility {
  PUBLIC  @map("public")
  PRIVATE @map("private")
}

model Question {
  id                  String                @id @default(uuid()) @map("id") @db.Uuid
  text                String                @map("text") @db.Text
  answer              String?               @map("answer") @db.Text
  departmentId        String                @map("department_id") @db.Uuid
  department          Department            @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  knowledgeChunkId    String?               @map("knowledge_chunk_id") @db.Uuid
  knowledgeChunk      KnowledgeChunk?       @relation(fields: [knowledgeChunkId], references: [id], onDelete: Cascade)
  createdAt           DateTime              @default(now()) @map("created_at")
  updatedAt           DateTime              @updatedAt @map("updated_at")
  creatorSupervisorId String?               @map("creator_supervisor_id") @db.Uuid
  creatorSupervisor   Supervisor?           @relation(fields: [creatorSupervisorId], references: [id], onDelete: Cascade)
  creatorAdminId      String?               @map("creator_admin_id") @db.Uuid
  creatorAdmin        Admin?                @relation(fields: [creatorAdminId], references: [id], onDelete: Cascade)
  creatorEmployeeId   String?               @map("creator_employee_id") @db.Uuid
  creatorEmployee     Employee?             @relation(fields: [creatorEmployeeId], references: [id], onDelete: Cascade)
  interactions        QuestionInteraction[]
  satisfaction        Int                   @default(0) @map("satisfaction")
  dissatisfaction     Int                   @default(0) @map("dissatisfaction")
  views               Int                   @default(0) @map("views")
  questionViews       QuestionView[]

  @@index([departmentId])
  @@index([creatorSupervisorId])
  @@map("questions")
}

model QuestionInteraction {
  id        String          @id @default(uuid()) @map("id") @db.Uuid
  type      InteractionType @map("type")
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  questionId String   @map("question_id") @db.Uuid
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  guestId    String   @map("guest_id") @db.Uuid
  guest      Guest    @relation(fields: [guestId], references: [id], onDelete: Cascade)

  @@unique([questionId, guestId])
  @@index([questionId])
  @@index([guestId])
  @@map("question_interactions")
}

model QuestionView {
  id         String   @id @default(uuid()) @map("id") @db.Uuid
  questionId String   @map("question_id") @db.Uuid
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  guestId    String   @map("guest_id") @db.Uuid
  guest      Guest    @relation(fields: [guestId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([questionId, guestId])
  @@index([questionId])
  @@index([guestId])
  @@map("question_views")
}

model KnowledgeChunk {
  id              String           @id @default(uuid()) @map("id") @db.Uuid
  content         String           @map("content") @db.Text
  departmentId    String           @map("department_id") @db.Uuid
  department      Department       @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  pointId         String?          @map("point_id") @db.Uuid
  questions       Question[]
  retrievedChunks RetrievedChunk[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([pointId])
  @@index([departmentId])
  @@map("knowledge_chunks")
}

model Conversation {
  id        String    @id @default(uuid()) @map("id") @db.Uuid
  guestId   String    @map("guest_id") @db.Uuid
  guest     Guest?    @relation(fields: [guestId], references: [id], onDelete: Cascade)
  messages  Message[]
  createdAt DateTime  @default(now()) @map("created_at")
  startedAt DateTime  @default(now()) @map("started_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  endedAt   DateTime? @map("ended_at")
  isDeleted Boolean   @default(false) @map("is_deleted")

  @@index([guestId, isDeleted])
  @@map("conversations")
}

model Message {
  id             String          @id @default(uuid()) @map("id") @db.Uuid
  content        String          @map("content") @db.Text
  role           MessageRole     @map("role")
  conversationId String          @map("conversation_id") @db.Uuid
  conversation   Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  retrievedChunk RetrievedChunk?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  @@index([conversationId])
  @@map("messages")
}

model RetrievedChunk {
  id               String          @id @default(uuid()) @map("id") @db.Uuid
  messageId        String          @unique @map("message_id") @db.Uuid
  message          Message         @relation(fields: [messageId], references: [id], onDelete: Cascade)
  knowledgeChunkId String          @map("knowledge_chunk_id") @db.Uuid
  knowledgeChunk   KnowledgeChunk? @relation(fields: [knowledgeChunkId], references: [id], onDelete: Cascade)
  score            Float           @map("score")
  retrievedAt      DateTime        @default(now()) @map("retrieved_at")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")

  @@index([knowledgeChunkId])
  @@map("retrieved_chunks")
}

model Ticket {
  id              String        @id @default(uuid()) @map("id") @db.Uuid
  guestId         String?       @map("guest_id") @db.Uuid
  guest           Guest?        @relation(fields: [guestId], references: [id], onDelete: Cascade)
  question        String        @map("question") @db.Text
  departmentId    String        @map("department_id") @db.Uuid
  department      Department    @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  pointId         String?       @map("point_id") @db.Uuid
  ticketCode      String        @unique @map("ticket_code") @db.VarChar(255)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  status          TicketStatus  @default(PENDING) @map("status")
  isAutoGenerated Boolean       @default(true) @map("is_auto_generated")
  answer          TicketAnswer?

  @@index([pointId, isAutoGenerated])
  @@index([departmentId])
  @@index([guestId])
  @@map("tickets")
}

enum TicketStatus {
  PENDING
  IN_PROGRESS
  CLOSED
}

model SupportTicket {
  id           String                    @id @default(uuid()) @map("id") @db.Uuid
  guestId      String                    @map("guest_id") @db.Uuid
  guest        Guest                     @relation(fields: [guestId], references: [id], onDelete: Cascade)
  subject      String                    @map("subject") @db.VarChar(255)
  description  String                    @map("description") @db.Text
  departmentId String                    @map("department_id") @db.Uuid
  department   Department                @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  status       SupportTicketStatus       @default(NEW) @map("status")
  createdAt    DateTime                  @default(now()) @map("created_at")
  updatedAt    DateTime                  @updatedAt @map("updated_at")
  answeredAt   DateTime?                 @map("answered_at")
  answer       SupportTicketAnswer?
  assigneeId   String?                   @map("assignee_id") @db.Uuid
  assignee     Employee?                 @relation("AssigneeOfSupportTicket", fields: [assigneeId], references: [id], onDelete: Cascade)
  code         String                    @unique @map("code") @db.VarChar(10)
  interaction  SupportTicketInteraction?

  @@index([guestId])
  @@index([departmentId, status])
  @@map("support_tickets")
}

model SupportTicketAnswer {
  id                   String        @id @default(uuid()) @map("id") @db.Uuid
  supportTicketId      String        @unique @map("support_ticket_id") @db.Uuid
  supportTicket        SupportTicket @relation(fields: [supportTicketId], references: [id], onDelete: Cascade)
  content              String        @map("content") @db.Text
  answererSupervisorId String?       @map("answerer_supervisor_id") @db.Uuid
  answererSupervisor   Supervisor?   @relation("AnswererOfSupportTicketAnswer", fields: [answererSupervisorId], references: [id], onDelete: Cascade)
  answererEmployeeId   String?       @map("answerer_employee_id") @db.Uuid
  answererEmployee     Employee?     @relation("AnswererOfSupportTicketAnswer", fields: [answererEmployeeId], references: [id], onDelete: Cascade)
  answererAdminId      String?       @map("answerer_admin_id") @db.Uuid
  answererAdmin        Admin?        @relation("AnswererOfSupportTicketAnswer", fields: [answererAdminId], references: [id], onDelete: Cascade)
  createdAt            DateTime      @default(now()) @map("created_at")
  updatedAt            DateTime      @updatedAt @map("updated_at")
  rating               Rating?       @map("rating")

  @@index([answererSupervisorId, answererEmployeeId, answererAdminId])
  @@map("support_ticket_answers")
}

model SupportTicketInteraction {
  id              String                       @id @default(uuid()) @map("id") @db.Uuid
  supportTicketId String                       @unique @map("support_ticket_id") @db.Uuid
  supportTicket   SupportTicket                @relation(fields: [supportTicketId], references: [id], onDelete: Cascade)
  guestId         String?                      @map("guest_id") @db.Uuid
  guest           Guest?                       @relation(fields: [guestId], references: [id], onDelete: Cascade)
  type            SupportTicketInteractionType @map("type")
  createdAt       DateTime                     @default(now()) @map("created_at")
  updatedAt       DateTime                     @updatedAt @map("updated_at")

  @@index([supportTicketId])
  @@index([guestId])
  @@map("support_ticket_interactions")
}

enum SupportTicketInteractionType {
  SATISFACTION    @map("satisfaction")
  DISSATISFACTION @map("dissatisfaction")

  @@map("support_ticket_interaction_type")
}

enum TaskAssignmentType {
  INDIVIDUAL     @map("individual")
  DEPARTMENT     @map("department")
  SUB_DEPARTMENT @map("sub_department")

  @@map("task_assignment_type")
}

model Task {
  id          String @id @default(uuid()) @map("id") @db.Uuid
  title       String @map("title") @db.VarChar(255)
  description String @map("description") @db.Text

  assigneeId String?   @map("assignee_id") @db.Uuid
  assignee   Employee? @relation("AssigneeOfTask", fields: [assigneeId], references: [id], onDelete: Cascade)

  assignerSupervisorId String?     @map("assigner_supervisor_id") @db.Uuid
  assignerSupervisor   Supervisor? @relation("AssignerOfTask", fields: [assignerSupervisorId], references: [id], onDelete: Cascade)
  assignerAdminId      String?     @map("assigner_admin_id") @db.Uuid
  assignerAdmin        Admin?      @relation("AssignerOfTask", fields: [assignerAdminId], references: [id], onDelete: Cascade)

  approverSupervisorId String?     @map("approver_supervisor_id") @db.Uuid
  approverSupervisor   Supervisor? @relation("ApproverOfTask", fields: [approverSupervisorId], references: [id], onDelete: Cascade)
  approverAdminId      String?     @map("approver_admin_id") @db.Uuid
  approverAdmin        Admin?      @relation("ApproverOfTask", fields: [approverAdminId], references: [id], onDelete: Cascade)

  status         TaskStatus         @default(TODO) @map("status")
  assignmentType TaskAssignmentType @map("assignment_type")

  targetDepartmentId    String?     @map("target_department_id") @db.Uuid
  targetDepartment      Department? @relation("TargetDepartment", fields: [targetDepartmentId], references: [id], onDelete: Cascade)
  targetSubDepartmentId String?     @map("target_sub_department_id") @db.Uuid
  targetSubDepartment   Department? @relation("TargetSubDepartment", fields: [targetSubDepartmentId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  completedAt   DateTime? @map("completed_at")
  assignerNotes String?   @map("assigner_notes") @db.Text
  feedback      String?   @map("feedback") @db.Text

  performerEmployeeId   String?     @map("performer_employee_id") @db.Uuid
  performerEmployee     Employee?   @relation("PerformerOfTask", fields: [performerEmployeeId], references: [id], onDelete: Cascade)
  performerSupervisorId String?     @map("performer_supervisor_id") @db.Uuid
  performerSupervisor   Supervisor? @relation("PerformerOfTask", fields: [performerSupervisorId], references: [id], onDelete: Cascade)
  performerAdminId      String?     @map("performer_admin_id") @db.Uuid
  performerAdmin        Admin?      @relation("PerformerOfTask", fields: [performerAdminId], references: [id], onDelete: Cascade)

  @@index([assigneeId])
  @@index([assignerSupervisorId])
  @@index([assignerAdminId])
  @@index([targetDepartmentId])
  @@index([targetSubDepartmentId])
  @@index([approverAdminId, approverSupervisorId, status])
  @@map("tasks")
}

// Removed TaskAttachment junction; attachments now reference their targets via Attachment.targetId

enum TaskAttachmentType {
  ASSIGNER @map("assigner")
  ASSIGNEE @map("assignee")

  @@map("task_attachment_type")
}

enum TaskStatus {
  TODO                      @map("to_do")
  SEEN                      @map("seen")
  PENDING_REVIEW            @map("pending_review")
  PENDING_SUPERVISOR_REVIEW @map("pending_supervisor_review")
  COMPLETED                 @map("completed")

  @@map("task_status")
}

enum Rating {
  SATISFACTION    @map("satisfaction")
  DISSATISFACTION @map("dissatisfaction")

  @@map("rating")
}

// Removed SupportTicketAnswerAttachment junction

// Removed SupportTicketAttachment junction

enum SupportTicketStatus {
  NEW      @map("new")
  SEEN     @map("seen")
  ANSWERED @map("answered")
  CLOSED   @map("closed")

  @@map("support_ticket_status")
}

model TicketAnswer {
  id        String   @id @default(uuid()) @map("id") @db.Uuid
  ticketId  String   @unique @map("ticket_id") @db.Uuid
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  content   String   @map("content") @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ticket_answers")
}

enum UserRole {
  SUPERVISOR @map("supervisor")
  ADMIN      @map("admin")
  EMPLOYEE   @map("employee")
  DRIVER     @map("driver")

  @@map("user_role")
}

model PushSubscription {
  id             String    @id @default(uuid()) @map("id") @db.Uuid
  userId         String    @map("user_id") @db.VarChar(255)
  endpoint       String    @map("endpoint") @db.Text
  expirationTime DateTime? @map("expiration_time")
  keys           Json      @map("keys")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@map("push_subscriptions")
}

enum MessageRole {
  USER      @map("user")
  ASSISTANT @map("assistant")

  @@map("message_role")
}

enum InteractionType {
  SATISFACTION    @map("satisfaction")
  DISSATISFACTION @map("dissatisfaction")
  VIEW            @map("view")

  @@map("interaction_type")
}

model Attachment {
  id   String @id @default(uuid()) @map("id") @db.Uuid
  type String @map("type") @db.VarChar(255)
  url  String @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  // Generic target reference; indexed for fast lookup
  targetId  String   @map("target_id") @db.Uuid

  @@index([targetId])
  @@map("attachments")
}

model Vehicle {
  id                  String          @id @default(uuid()) @map("id") @db.Uuid
  make                String          @map("make") @db.VarChar(255)
  model               String          @map("model") @db.VarChar(255)
  year                Int             @map("year")
  plateNumber         String          @map("plate_number") @db.VarChar(255)
  vin                 String          @map("vin") @db.VarChar(255)
  status              VehicleStatus   @default(ACTIVE) @map("status")
  driverId            String          @map("driver_id") @db.Uuid
  driver              Driver          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  notes               String?         @map("notes") @db.Text
  nextMaintenanceDate DateTime?       @map("next_maintenance_date")
  license             VehicleLicense?
  violations          Violation[]

  @@index([driverId, status])
  @@map("vehicles")
}

model VehicleLicense {
  id                    String                @id @default(uuid()) @map("id") @db.Uuid
  vehicleId             String                @unique @map("vehicle_id") @db.Uuid
  vehicle               Vehicle               @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  licenseNumber         String                @map("license_number") @db.VarChar(255)
  issueDate             DateTime              @map("issue_date")
  expiryDate            DateTime              @map("expiry_date")
  insurancePolicyNumber String?               @map("insurance_policy_number") @db.VarChar(255)
  insuranceExpiryDate   DateTime?             @map("insurance_expiry_date")
  status                VehicleLicenseStatus? @map("status")
  // attachment moved to Attachment with targetId

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("vehicle_licenses")
}

// Removed VehicleLicenseAttachment junction

enum VehicleLicenseStatus {
  ACTIVE        @map("active")
  EXPIRING_SOON @map("expiring_soon")
  EXPIRED       @map("expired")

  @@map("vehicle_license_status")
}

// Removed VehiclePhoto junction

enum VehicleStatus {
  ACTIVE         @map("active")
  IN_MAINTENANCE @map("in_maintenance")
  OUT_OF_SERVICE @map("out_of_service")

  @@map("vehicle_status")
}

model Violation {
  id             String        @id @default(uuid()) @map("id") @db.Uuid
  driverId       String        @map("driver_id") @db.Uuid
  driver         Driver        @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicleId      String        @map("vehicle_id") @db.Uuid
  vehicle        Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  ruleId         String        @map("rule_id") @db.Uuid
  rule           ViolationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  description    String        @map("description") @db.Text
  amount         Float         @map("amount")
  isPaid         Boolean       @default(false) @map("is_paid")
  triggerEventId String        @map("trigger_event_id") @db.VarChar(255)
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  @@index([driverId])
  @@index([vehicleId])
  @@index([ruleId, isPaid])
  @@map("violations")
}

// Removed ViolationAttachment junction

model ViolationRule {
  id          String        @id @default(uuid()) @map("id") @db.Uuid
  type        ViolationType @map("type")
  threshold   Int           @map("threshold")
  fineAmount  Int           @map("fine_amount")
  description String        @map("description") @db.Text
  isEnabled   Boolean       @default(true) @map("is_enabled")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  violations  Violation[]

  @@map("violation_rules")
}

enum ViolationType {
  SPEEDING           @map("speeding")
  MISSED_MAINTENANCE @map("missed_maintenance")

  @@map("violation_type")
}

model EmployeeRequest {
  id String @id @default(uuid()) @map("id") @db.Uuid

  requestedBySupervisor   Supervisor @relation("SupervisorRequests", fields: [requestedBySupervisorId], references: [id])
  requestedBySupervisorId String     @map("requested_by_supervisor_id") @db.Uuid

  newEmployeeEmail       String  @map("new_employee_email") @db.VarChar(255)
  newEmployeeFullName    String  @map("new_employee_full_name") @db.VarChar(255)
  newEmployeeUsername    String  @map("new_employee_username") @db.VarChar(255)
  newEmployeeJobTitle    String  @map("new_employee_job_title") @db.VarChar(255)
  temporaryPassword      String  @map("temporary_password") @db.VarChar(255)
  newEmployeeDesignation String? @map("new_employee_designation") @db.VarChar(255)
  newEmployeeId          String? @map("new_employee_id") @db.VarChar(255)

  status RequestStatus @default(PENDING) @map("status")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  resolvedAt        DateTime? @map("resolved_at")
  resolvedByAdmin   Admin?    @relation("AdminResolutions", fields: [resolvedByAdminId], references: [id])
  resolvedByAdminId String?   @map("resolved_by_admin_id") @db.Uuid

  rejectionReason          String? @map("rejection_reason") @db.Text
  acknowledgedBySupervisor Boolean @default(false) @map("acknowledged_by_supervisor")

  @@index([requestedBySupervisorId])
  @@index([resolvedByAdminId, status])
  @@map("employee_requests")
}

enum RequestStatus {
  PENDING  @map("pending")
  APPROVED @map("approved")
  REJECTED @map("rejected")

  @@map("request_status")
}

model ActivityLog {
  id     String          @id @default(uuid()) @map("id") @db.Uuid
  type   ActivityLogType
  title  String
  itemId String          @map("item_id") @db.VarChar(255)
  meta   Json

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  occurredAt DateTime @map("occurred_at") // ISO instant coming from the source
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String   @map("user_id") @db.Uuid

  @@index([userId])
  @@index([type])
  @@index([occurredAt])
  @@map("activity_logs")
}

enum ActivityLogType {
  TICKET_ANSWERED   @map("ticket_answered")
  TASK_PERFORMED    @map("task_performed")
  TASK_APPROVED     @map("task_approved")
  FAQ_CREATED       @map("faq_created")
  FAQ_UPDATED       @map("faq_updated")
  PROMOTION_CREATED @map("promotion_created")
  STAFF_REQUEST_CREATED     @map("staff_request_created")
}

model Promotion {
  id    String @id @default(uuid()) @map("id") @db.Uuid
  title String @map("title") @db.VarChar(255)

  audience AudienceType @map("audience")
  isActive Boolean      @default(true) @map("is_active")

  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  startDate DateTime? @map("start_date")
  endDate   DateTime? @map("end_date")

  createdByAdminId      String?     @map("created_by_admin_id") @db.Uuid
  createdByAdmin        Admin?      @relation(fields: [createdByAdminId], references: [id], onDelete: Cascade)
  createdBySupervisorId String?     @map("created_by_supervisor_id") @db.Uuid
  createdBySupervisor   Supervisor? @relation(fields: [createdBySupervisorId], references: [id], onDelete: Cascade)

  @@index([createdByAdminId, isActive, createdBySupervisorId])
  @@map("promotions")
}

// Removed PromotionAttachment junction

enum AudienceType {
  CUSTOMER   @map("customer")
  SUPERVISOR @map("supervisor")
  EMPLOYEE   @map("employee")
  ALL        @map("all")

  @@map("audience_type")
}
